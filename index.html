<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Arcade - Cyberpunk Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #020617;
            --card-bg: rgba(30, 41, 59, 0.6);
            --cyan-neon: #22d3ee;
            --purple-neon: #a855f7;
            --green-neon: #4ade80;
            --gold: #fbbf24;
            --text-main: #f8fafc;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, rgba(34, 211, 238, 0.15) 0%, transparent 50%);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* Scanline Effect */
        body::before {
            content: " ";
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(34, 211, 238, 0.1);
            z-index: 1000; pointer-events: none;
            animation: scan 8s linear infinite;
        }
        @keyframes scan { from { top: 0; } to { top: 100%; } }

        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
        .user-profile { display: flex; align-items: center; gap: 10px; font-size: 0.85rem; }

        .points-panel { text-align: center; padding: 10px 0; }
        .points-label { text-transform: uppercase; letter-spacing: 2px; font-size: 0.65rem; color: var(--cyan-neon); }
        .points-value { font-size: 3rem; font-weight: 900; text-shadow: 0 0 15px rgba(34, 211, 238, 0.4); margin: 0; }

        .view-section { display: none; flex-direction: column; gap: 15px; padding: 15px; overflow-y: auto; flex-grow: 1; padding-bottom: 100px; }
        .view-section.active { display: flex; }

        .game-card, .task-card {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: 0.2s;
        }
        .game-card:active { transform: scale(0.98); border-color: var(--cyan-neon); }

        .game-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; border: 1px solid; }
        .tap-icon { color: var(--cyan-neon); box-shadow: 0 0 8px var(--cyan-neon); }
        .plinko-icon { color: var(--purple-neon); box-shadow: 0 0 8px var(--purple-neon); }
        .pet-icon { color: var(--green-neon); box-shadow: 0 0 8px var(--green-neon); }

        .game-info h3 { margin: 0; font-size: 1rem; }
        .game-info p { margin: 2px 0 0; font-size: 0.7rem; opacity: 0.6; }

        .btn-claim { background: var(--gold); color: #000; border: none; padding: 6px 12px; border-radius: 6px; font-weight: bold; font-size: 0.7rem; cursor: pointer; }
        .btn-claim:disabled { background: #444; color: #888; }

        .game-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 100; display: none; flex-direction: column;
        }

        canvas { background: #000; border: 2px solid var(--purple-neon); border-radius: 10px; max-width: 95%; }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(15, 23, 42, 0.95);
            display: flex; justify-content: space-around;
            padding: 10px 0 25px; border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 50;
        }
        .nav-item { color: #64748b; font-size: 0.65rem; text-decoration: none; text-align: center; background: none; border: none; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--cyan-neon); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; }

        .leaderboard-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

    <header>
        <div class="user-profile">
            <i class="fa-solid fa-user-astronaut"></i>
            <span id="username">WELCOME_USER</span>
        </div>
        <div style="font-size: 0.8rem; color: var(--green-neon);"><i class="fa-solid fa-signal"></i> ONLINE</div>
    </header>

    <div class="points-panel">
        <div class="points-label">Total Balance</div>
        <div class="points-value" id="main-points">0</div>
    </div>

    <div id="section-home" class="view-section active">
        <div class="game-card" onclick="openGame('tap')">
            <div class="game-icon tap-icon"><i class="fa-solid fa-hand-pointer"></i></div>
            <div class="game-info"><h3>CYBER CLICKER</h3><p>Tap core for instant credits</p></div>
        </div>
        <div class="game-card" onclick="openGame('plinko')">
            <div class="game-icon plinko-icon"><i class="fa-solid fa-tower-broadcast"></i></div>
            <div class="game-info"><h3>PLINKO DROPS</h3><p>Physics-based luck system</p></div>
        </div>
        <div class="game-card" onclick="openGame('pet')">
            <div class="game-icon pet-icon"><i class="fa-solid fa-microchip"></i></div>
            <div class="game-info"><h3>NEURAL PET</h3><p>Battery maintenance mode</p></div>
        </div>
    </div>

    <div id="section-earn" class="view-section">
        <div class="task-card">
            <div class="game-icon" style="color:var(--gold); border-color:var(--gold);"><i class="fa-solid fa-gift"></i></div>
            <div class="game-info" style="flex-grow:1;">
                <h3>DAILY LOGIN</h3>
                <p id="claim-timer">Ready to claim</p>
            </div>
            <button id="daily-claim-btn" class="btn-claim" onclick="claimDaily()">CLAIM</button>
        </div>
        
        <h4 style="margin: 10px 0 0; color:var(--cyan-neon); font-size: 0.8rem;">SOCIAL MISSIONS</h4>
        <div class="task-card">
            <i class="fa-brands fa-telegram" style="font-size: 1.5rem; color: #229ED9;"></i>
            <div class="game-info" style="flex-grow:1;"><h3>JOIN CHANNEL</h3><p>+1000 Credits</p></div>
            <button class="btn-claim" onclick="doTask('https://t.me/yourchannel', 1000, this)">GO</button>
        </div>
        <div class="task-card">
            <i class="fa-brands fa-x-twitter" style="font-size: 1.5rem; color: #fff;"></i>
            <div class="game-info" style="flex-grow:1;"><h3>FOLLOW ON X</h3><p>+1000 Credits</p></div>
            <button class="btn-claim" onclick="doTask('https://twitter.com/yourhandle', 1000, this)">GO</button>
        </div>
    </div>

    <div id="section-rank" class="view-section">
        <h3 style="text-align: center; color: var(--cyan-neon);"><i class="fa-solid fa-trophy"></i> TOP OPERATORS</h3>
        <div id="leaderboard-list">
            <div style="text-align:center; padding:20px; opacity:0.5;">Loading Global Data...</div>
        </div>
    </div>

    <div class="game-overlay" id="game-overlay">
        <div style="padding: 20px;" onclick="closeGame()"><i class="fa-solid fa-chevron-left"></i> BACK</div>
        <div id="game-content" style="flex-grow:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding: 20px;"></div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showSection('home', this)"><i class="fa-solid fa-gamepad"></i><br>GAMES</button>
        <button class="nav-item" onclick="showSection('earn', this)"><i class="fa-solid fa-coins"></i><br>EARN</button>
        <button class="nav-item" onclick="showSection('rank', this)"><i class="fa-solid fa-ranking-star"></i><br>RANK</button>
        <button class="nav-item" onclick="shareScore()"><i class="fa-solid fa-user-plus"></i><br>INVITE</button>
    </nav>

<script>
    const tg = window.Telegram.WebApp;
    // --- REPLACE THIS WITH YOUR WORKER URL ---
    const API_URL = "https://ricotg-arcade.pages.dev/"; 
    
    tg.expand();
    tg.ready();

    let totalPoints = parseInt(localStorage.getItem('totalPoints')) || 1000;
    let lastClaim = parseInt(localStorage.getItem('lastClaim')) || 0;
    let plinkoActive = false;

    // Initialization
    document.getElementById('username').innerText = `@${tg.initDataUnsafe.user?.username || 'PLAYER_01'}`;
    updatePointsDisplay();
    updateLeaderboard();
    setInterval(updateDailyTimer, 60000);
    updateDailyTimer();

    // Core Logic
    async function updatePointsDisplay() {
        document.getElementById('main-points').innerText = totalPoints.toLocaleString();
        localStorage.setItem('totalPoints', totalPoints);
        
        // Sync to Cloudflare
        const username = tg.initDataUnsafe.user?.username || "Anonymous";
        try {
            await fetch(`${API_URL}/save`, {
                method: "POST",
                body: JSON.stringify({ username, points: totalPoints }),
                headers: { "Content-Type": "application/json" }
            });
        } catch (e) { console.warn("Score sync delayed..."); }
    }

    async function updateLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        try {
            const response = await fetch(`${API_URL}/list`);
            const topPlayers = await response.json();
            
            list.innerHTML = topPlayers.map((u, i) => `
                <div class="leaderboard-item">
                    <span>#${i+1} @${u.username}</span>
                    <span style="color:var(--cyan-neon)">${u.points.toLocaleString()}</span>
                </div>
            `).join('');
        } catch (e) {
            list.innerHTML = "<div style='text-align:center; padding:20px;'>Database Offline</div>";
        }
    }

    function showSection(id, btn) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('section-' + id).classList.add('active');
        btn.classList.add('active');
        if(id === 'rank') updateLeaderboard();
        tg.HapticFeedback.impactOccurred('light');
    }

    function shareScore() {
        const text = `ðŸŽ® Join my Cyber Arcade! I have ${totalPoints} credits. Can you beat me?`;
        tg.switchInlineQuery(text);
    }

    // Daily Reward Logic
    function updateDailyTimer() {
        const now = Date.now();
        const diff = now - lastClaim;
        const btn = document.getElementById('daily-claim-btn');
        const timerText = document.getElementById('claim-timer');

        if (diff >= 86400000) {
            btn.disabled = false;
            btn.innerText = "CLAIM";
            timerText.innerText = "Daily bonus is ready!";
        } else {
            btn.disabled = true;
            btn.innerText = "WAIT";
            const hrs = Math.floor((86400000 - diff) / 3600000);
            timerText.innerText = `Next claim in ${hrs}h`;
        }
    }

    function claimDaily() {
        totalPoints += 500;
        lastClaim = Date.now();
        localStorage.setItem('lastClaim', lastClaim);
        updatePointsDisplay();
        updateDailyTimer();
        tg.showPopup({ message: "Daily reward of 500 credits added!" });
    }

    function doTask(url, reward, btn) {
        tg.openLink(url);
        setTimeout(() => {
            totalPoints += reward;
            updatePointsDisplay();
            btn.innerText = "DONE";
            btn.disabled = true;
            tg.showPopup({ message: `Task reward of ${reward} claimed!` });
        }, 5000);
    }

    // --- GAME ENGINE ---
    function openGame(type) {
        const overlay = document.getElementById('game-overlay');
        const content = document.getElementById('game-content');
        overlay.style.display = 'flex';
        content.innerHTML = "";

        if (type === 'tap') {
            content.innerHTML = `
                <div id="tap-circle" style="width:180px; height:180px; background:radial-gradient(circle, var(--cyan-neon), transparent); border-radius:50%; display:flex; align-items:center; justify-content:center; border:4px solid var(--cyan-neon); box-shadow: 0 0 20px var(--cyan-neon);">
                    <i class="fa-solid fa-fingerprint" style="font-size:4rem;"></i>
                </div>
                <h2 style="margin-top:30px; color:var(--cyan-neon);">CORE EXTRACTION</h2>
                <p>Tap core to mine credits</p>
            `;
            const circle = document.getElementById('tap-circle');
            const handler = (e) => {
                e.preventDefault();
                totalPoints += 2; updatePointsDisplay();
                tg.HapticFeedback.impactOccurred('light');
                circle.style.transform = "scale(0.95)";
                setTimeout(() => circle.style.transform = "scale(1)", 50);
            };
            circle.addEventListener('touchstart', handler);
        } else if (type === 'plinko') {
            content.innerHTML = `<canvas id="pCanvas" width="300" height="350"></canvas>
            <button onclick="dropBall()" class="btn-claim" style="margin-top:20px; padding:15px 30px;">DROP BALL (50 pts)</button>`;
            initPlinko();
        } else if (type === 'pet') {
            content.innerHTML = `<i class="fa-solid fa-robot" style="font-size:6rem; color:var(--green-neon);"></i>
            <h3>NEURAL BOT</h3><p>Battery: 100%</p>
            <button class="btn-claim" onclick="tg.showPopup({message:'Battery is currently full!'})">RECHARGE</button>`;
        }
    }

    let pCtx, balls = [], pins = [];
    function initPlinko() {
        const canvas = document.getElementById('pCanvas');
        pCtx = canvas.getContext('2d');
        plinkoActive = true;
        pins = [];
        for (let r = 2; r < 9; r++) {
            for (let i = 0; i <= r; i++) pins.push({ x: 150 + (i - r/2) * 30, y: 30 + r * 35 });
        }
        requestAnimationFrame(updatePlinko);
    }

    function dropBall() {
        if (totalPoints < 50) return tg.showAlert("Need 50 credits!");
        totalPoints -= 50; updatePointsDisplay();
        balls.push({ x: 150 + (Math.random()-0.5)*5, y: 10, vx: 0, vy: 2 });
    }

    function updatePlinko() {
        if (!plinkoActive || !pCtx) return;
        pCtx.fillStyle = "#000"; pCtx.fillRect(0,0,300,350);
        pCtx.fillStyle = "#444";
        pins.forEach(p => { pCtx.beginPath(); pCtx.arc(p.x, p.y, 2, 0, Math.PI*2); pCtx.fill(); });
        pCtx.fillStyle = "#a855f7";
        balls.forEach((b, idx) => {
            b.vy += 0.15; b.x += b.vx; b.y += b.vy;
            pins.forEach(p => {
                let d = Math.hypot(b.x - p.x, b.y - p.y);
                if (d < 8) { b.vy *= -0.4; b.vx = (b.x - p.x) * 0.5; tg.HapticFeedback.impactOccurred('light'); }
            });
            pCtx.beginPath(); pCtx.arc(b.x, b.y, 5, 0, Math.PI*2); pCtx.fill();
            if (b.y > 350) { 
                balls.splice(idx,1); 
                let win = [0, 50, 100, 500, 20][Math.floor(Math.random()*5)];
                totalPoints += win; updatePointsDisplay();
            }
        });
        requestAnimationFrame(updatePlinko);
    }

    function closeGame() {
        document.getElementById('game-overlay').style.display = 'none';
        plinkoActive = false;
        updateLeaderboard();
    }
</script>
</body>
</html>
